apply plugin: 'c'

model {
    toolChains {
		   gcc(Gcc) {
	              path System.properties['org.bulldog.gcc.arm.root']
	              cCompiler.executable = System.properties['org.bulldog.gcc.arm.ccompiler']
            	  cppCompiler.executable = System.properties['org.bulldog.gcc.arm.cppcompiler']
            	  linker.executable = System.properties['org.bulldog.gcc.arm.linker']
            	  assembler.executable = System.properties['org.bulldog.gcc.arm.assembler']
            	  staticLibArchiver.executable = System.properties['org.bulldog.gcc.arm.archiver']
	              addPlatformConfiguration(new BeagleboneBlackArmArchitecture())
	              addPlatformConfiguration(new RaspberryPiArmArchitecture())
				  addPlatformConfiguration(new CubieboardArchitecture())
	        }
    }
    
    platforms {
        
        beagleboneblack {
            architecture "arm"
            operatingSystem "linux"
        }
        
        raspberrypi {
        	architecture "arm"
        	operatingSystem "linux"
        }
		
		cubieboard {
        	architecture "arm"
        	operatingSystem "linux"
        }
    }
}

sources {
    bulldog {
        c {
            source {
                srcDir "./src/main/c"
                include "**/*.c"
            }
            
            exportedHeaders {
            	srcDirs "../src/main/c/"
            	include '**/*.h'
            }
        }
    }   
}

libraries() {
	bulldog() {
		binaries.withType(SharedLibraryBinary) {
          	sharedLibraryFile = new File(sharedLibraryFile.parent, "libbulldog-linux.so")
        }
        
        binaries.all {
        	 tasks.withType(CCompile) {
                    includes.from(System.properties['org.bulldog.jdk.arm.includes'])
                    includes.from(System.properties['org.bulldog.jdk.arm.includes.linux'])
                    includes.from(System.properties['org.bulldog.gcc.arm.includes'])
                }
        }
	}	
}

class BeagleboneBlackArmArchitecture implements TargetPlatformConfiguration {

	def compilerArgs =  ["-std=gnu11", "-O3", "-fPIC", "-mthumb-interwork", "-march=armv7-a", "-fgnu89-inline",
						 "-mtune=cortex-a8", "-mfloat-abi=hard", "-mfpu=neon"]
	def linkerArgs =  ["-lgcc"]

    boolean supportsPlatform(Platform element) {
    	return element.toString().contains('beagleboneblack')
    }

    List<String> getCppCompilerArgs() {
       compilerArgs
    }

    List<String> getCCompilerArgs() {
       compilerArgs
    }

    List<String> getObjectiveCCompilerArgs() {
        []
    }

    List<String> getObjectiveCppCompilerArgs() {
        []
    }

    List<String> getAssemblerArgs() {
        []
    }

    List<String> getLinkerArgs() {
       linkerArgs
    }

    List<String> getStaticLibraryArchiverArgs() {
        []
    }
}

class RaspberryPiArmArchitecture implements TargetPlatformConfiguration {

	def compilerArgs =  ["-std=gnu11", "-O3", "-fPIC", "-fgnu89-inline", "-mfloat-abi=hard",
						 "-mlittle-endian", "-DARM", "-DARCH=\"ARM\"" , "-marm", "-mtune=arm1176jzf-s"]
	def linkerArgs =  ["-lgcc"]

    boolean supportsPlatform(Platform element) {
    	return element.toString().contains('raspberrypi')
    }

    List<String> getCppCompilerArgs() {
       compilerArgs
    }

    List<String> getCCompilerArgs() {
       compilerArgs
    }

    List<String> getObjectiveCCompilerArgs() {
        []
    }

    List<String> getObjectiveCppCompilerArgs() {
        []
    }

    List<String> getAssemblerArgs() {
        []
    }

    List<String> getLinkerArgs() {
       linkerArgs
    }

    List<String> getStaticLibraryArchiverArgs() {
        []
    }
}

class CubieboardArchitecture implements TargetPlatformConfiguration {

	def compilerArgs =  ["-std=gnu11", "-O3", "-fPIC", "-fgnu89-inline", "-mfloat-abi=hard",
						 "-mlittle-endian", "-DARM", "-DARCH=\"ARM\"" , "-marm", "-mcpu=cortex-a7", 
						 "-mtune=cortex-a7", "-mfpu=vfpv4-d16", "-mfpu=neon-vfpv4", 
						 "-funsafe-math-optimizations"]
	def linkerArgs =  ["-lgcc"]

    boolean supportsPlatform(Platform element) {
    	return element.toString().contains('cubieboard')
    }

    List<String> getCppCompilerArgs() {
       compilerArgs
    }

    List<String> getCCompilerArgs() {
       compilerArgs
    }

    List<String> getObjectiveCCompilerArgs() {
        []
    }

    List<String> getObjectiveCppCompilerArgs() {
        []
    }

    List<String> getAssemblerArgs() {
        []
    }

    List<String> getLinkerArgs() {
       linkerArgs
    }

    List<String> getStaticLibraryArchiverArgs() {
        []
    }
}